<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Printer (78x50mm) + QR</title>
    <!-- Import Font Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import QRCode.js áŸá˜áŸ’ášá¶á”áŸ‹á”á„áŸ’á€á¾á QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Kantumruy Pro"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366f1', /* Indigo 500 */
                        secondary: '#0ea5e9', /* Sky 500 */
                        success: '#10b981', /* Emerald 500 */
                        danger: '#f43f5e', /* Rose 500 */
                        warning: '#f59e0b', /* Amber 500 */
                        dark: {
                            bg: '#0f172a',      /* Slate 900 */
                            card: '#1e293b',    /* Slate 800 */
                            input: '#334155',   /* Slate 700 */
                            border: '#475569',  /* Slate 600 */
                            text: '#f1f5f9',    /* Slate 100 */
                            muted: '#94a3b8'    /* Slate 400 */
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Variables áŸá˜áŸ’ášá¶á”áŸ‹á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á‘áŸ†á áŸ† á“á·á„ Margin */
        :root {
            --page-width: 78mm;
            --page-height: 50mm;
            --page-margin-top: 0mm;
            --page-margin-right: 0mm;
            --page-margin-bottom: 0mm;
            --page-margin-left: 0mm;
        }

        html, body {
            box-sizing: border-box;
            font-family: 'Kantumruy Pro', sans-serif;
            color: #f1f5f9; /* Light text for Dark Mode body */
        }
        *, *:before, *:after { box-sizing: inherit; }

        /* --- STYLES áŸá˜áŸ’ášá¶á”áŸ‹ Label á‘á¶áŸ†á„á¢áŸáŸ‹ (á‘á¶áŸ†á„ Label áŠá¾á˜ á“á·á„ QR) --- */
        .label-page {
            /* á‘áŸ†á áŸ†ááŸ’ášá¼áœá”á¶á“á€áŸ†áááŸ‹áŠáŸ„á™ JS áá¶á˜ášá™áŸˆ CSS variables */
            width: var(--page-width); 
            height: var(--page-height);
            
            /* á–ááŸŒá•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™áŸ */
            background-color: white; 
            
            /* Padding áá¶á„á€áŸ’á“á»á„ */
            padding: 1mm 3mm; 
            
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 8pt;
            line-height: 1.15;
            overflow: hidden;
            position: relative;
            
            /* Visual Improvements for Screen Only - High Contrast Shadow */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            border: 1px solid #cbd5e1; /* Light border to define edge in dark mode */
            border-radius: 4px;
            
            color: #000; /* Ensure text is pure black on label */
            
            /* Important for Flex Layout: Prevent shrinking */
            flex-shrink: 0;
        }

        /* --- Styles áŸá˜áŸ’ášá¶á”áŸ‹ Label á–áŸááŸŒá˜á¶á“ (Label áŠá¾á˜) --- */
        .label-header {
            border-bottom: 1px dashed #000;
            display: flex;
            justify-content: space-between;
            font-size: 7pt;
            font-weight: 500;
            padding-bottom: 1mm;
            width: 100%;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
            gap: 1mm;
            padding-top: 0.5mm;
            padding-bottom: 0.5mm;
            width: 100%;
        }

        .info-block { flex: 1; }
        .info-block.right {
            text-align: right;
            border-left: 1px dashed #ccc;
            padding-left: 1mm;
            width: 40%;
        }
        .info-block.left { width: 60%; }

        .small-text { 
            font-size: 7pt; 
            font-weight: 500; 
            color: #333; 
        }
        
        .big-text { font-size: 10pt; font-weight: 700; } 
        #label-phone { font-size: 11pt; font-weight: 700; } 
        #label-location { font-size: 11pt; font-weight: 700; } 
        .data-text { font-size: 9pt; font-weight: 700; } 

        .total-box {
            background-color: #f1f5f9; /* Slate 100 */
            color: #000;
            padding: 0.5mm;
            border-radius: 0.125rem;
            font-weight: 700;
            font-size: 10pt;
            margin-top: 0.5mm;
        }
        #label-total { font-size: 10pt; }

        .cod-tag {
            font-size: 6.5pt;
            font-weight: 700;
            color: #000;
            background-color: #FFFFFF;
            padding: 0.5mm 1mm;
            margin-top: 1mm;
            line-height: 1.1;
            border: 1px solid #000;
            border-radius: 4px;
            display: block;
            text-align: right;
        }

        .label-footer {
            border-top: 1px dashed #000;
            text-align: center;
            font-size: 7pt;
            font-weight: 700;
            padding-top: 1mm;
            width: 100%;
        }

        /* --- Styles áŸá˜áŸ’ášá¶á”áŸ‹ QR Label ááŸ’á˜á¸ --- */
        #qr-label-container {
            align-items: center;
            justify-content: center;
            text-align: center;
            /* Use flexbox to distribute space vertically */
            display: flex !important;
            flex-direction: column;
            padding-top: 4mm;
            padding-bottom: 4mm;
        }
        #qrcode img {
            margin: 0 auto; 
            display: block;
            border: 1px solid #000; /* Add border to QR image itself */
            padding: 2px; /* White space between QR and border */
            background: white;
        }
        
        .qr-title {
            font-size: 11pt;
            font-weight: 800;
            margin-bottom: 2mm;
            text-transform: uppercase;
        }

        .qr-footer-box {
            border: 1px solid #000;
            border-radius: 4px;
            padding: 1mm 4mm;
            margin-top: 2mm;
            font-weight: 700;
            font-size: 8pt;
            background-color: #fff;
            box-shadow: 1px 1px 0px rgba(0,0,0,0.2);
        }

        /* ---------------- PRINT STYLES ---------------- */
        @page {
            size: var(--page-width) var(--page-height);
            margin-top: var(--page-margin-top);
            margin-right: var(--page-margin-right);
            margin-bottom: var(--page-margin-bottom);
            margin-left: var(--page-margin-left);
        }

        @media print {
            html, body {
                width: var(--page-width);
                height: var(--page-height);
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
                color: #000 !important;
            }

            /* Reset the Wrapper to Block for Print */
            #labels-wrapper {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Apply print styles to generic label-page class */
            .label-page {
                width: 100%;
                height: 100%;
                margin: 0 !important;
                padding: 1mm 3mm !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                page-break-after: always; /* áŠá¶á€áŸ‹ Page break */
                
                /* Reset colors for print */
                color: #000 !important;
            }

            .total-box {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .cod-tag, .qr-footer-box {
                 border: 1px solid #000 !important;
            }

            /* Class áŸá˜áŸ’ášá¶á”áŸ‹á›á¶á€áŸ‹ Element á–áŸá› Print */
            .hidden-on-print {
                display: none !important;
            }

            .no-print { display: none !important; }
            #styleEditor { display: none !important; }
        }
        /* ---------------- END PRINT STYLES ---------------- */


        body { background-color: #0f172a; /* Slate 900 background */ padding: 2rem 1rem; }

        /* Modal Styling Dark Mode */
        #print-guide-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(4px);
        }
        #print-guide-content {
            background: #1e293b;
            color: #f1f5f9;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 450px;
            width: 90%;
            border: 1px solid #334155;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }

        /* Design Mode Styles */
        .editable-element {
            cursor: default;
            transition: all 0.2s ease-in-out;
            border-radius: 2px;
        }
        .design-mode-active .editable-element {
            cursor: pointer;
            padding: 2px; 
        }
        .design-mode-active .editable-element:hover {
            background-color: rgba(99, 102, 241, 0.2); 
            outline: 1px dashed #6366f1;
        }
        .editable-element.selected {
            outline: 2px solid #6366f1; 
            background-color: rgba(99, 102, 241, 0.1);
            z-index: 10;
        }
        
        #styleEditor {
            position: fixed;
            z-index: 1001;
            background: #1e293b; 
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border: 1px solid #475569;
            bottom: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            max-width: 90%;
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom Input Styles Dark */
        .custom-input {
            transition: all 0.2s;
            background-color: #334155; 
            border-color: #475569; 
            color: white;
        }
        .custom-input:focus {
            ring-width: 2px;
            ring-color: #6366f1;
            border-color: #6366f1;
            outline: none;
        }

    </style>
</head>
<body>

    <!-- UI á˜á»á“á–áŸ’ášá¸á“ (Control Panel) -->
    <div class="no-print max-w-md mx-auto p-6 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl mb-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-white mb-1">ğŸ–¨ï¸ Label Printer</h1>
            <p class="text-sm text-slate-400">á”áŸ’ášá–áŸá“áŸ’á’á”á„áŸ’á€á¾ááŸáŸ’á›á¶á€áŠá¹á€á‡á‰áŸ’á‡á¼á“ (78mm x 50mm)</p>
        </div>

        <!-- á‡á˜áŸ’ášá¾áŸá‘áŸ†á áŸ† Label -->
        <div class="bg-slate-900/50 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-sm font-bold text-slate-300 mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-primary" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
                á‡á˜áŸ’ášá¾áŸá‘áŸ†á áŸ† Label (mm)
            </h2>
            <div class="flex items-center gap-6 mb-3">
                <label class="flex items-center cursor-pointer group">
                    <input type="radio" name="label_size" value="standard" checked class="form-radio text-primary focus:ring-primary h-4 w-4 bg-slate-700 border-slate-500">
                    <span class="ml-2 text-sm text-slate-300 group-hover:text-primary transition-colors">Standard (78x50)</span>
                </label>
                <label class="flex items-center cursor-pointer group">
                    <input type="radio" name="label_size" value="custom" class="form-radio text-primary focus:ring-primary h-4 w-4 bg-slate-700 border-slate-500">
                    <span class="ml-2 text-sm text-slate-300 group-hover:text-primary transition-colors">Customize</span>
                </label>
            </div>
            <!-- à¸Šà¹ˆà¸­à¸‡ Custom -->
            <div id="custom-size-inputs" class="hidden grid grid-cols-2 gap-3 mt-2">
                <div>
                    <label for="customWidth" class="block text-xs font-semibold text-slate-400 mb-1">á‘á‘á¹á„ (Width)</label>
                    <input type="number" id="customWidth" value="78" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label for="customHeight" class="block text-xs font-semibold text-slate-400 mb-1">á”ááŸ’áŠáŸ„á™ (Height)</label>
                    <input type="number" id="customHeight" value="50" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
            </div>
        </div>

         <!-- *** NEW: QR Code Settings (ALWAYS VISIBLE) *** -->
        <div id="qrSettingsPanel" class="bg-slate-900/50 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-sm font-bold text-slate-300 mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-success" viewBox="0 0 20 20" fill="currentColor">
                     <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V5h1v1H5zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zm2 2v-1h1v1H5zM13 3a1 1 0 00-1 1v3a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3zm1 2v1h1V5h-1z" clip-rule="evenodd" />
                    <path d="M11 11a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1h-6a1 1 0 01-1-1v-6zM17 13h-4v4h4v-4z" />
                </svg>
                QR Code Size
            </h2>
            <div class="flex items-center gap-3">
                 <div class="flex-grow">
                    <label for="qrSizeInput" class="block text-xs font-medium text-slate-400 mb-1">á‘áŸ†á áŸ† QR (px)</label>
                    <input type="number" id="qrSizeInput" value="100" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
            </div>
        </div>


        <!-- á€áŸ†áááŸ‹ Margins -->
        <div class="bg-slate-900/50 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-sm font-bold text-slate-300 mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-secondary" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm2 2v10h10V5H5z" clip-rule="evenodd" />
                </svg>
                á€áŸ†áááŸ‹ Margins (mm)
            </h2>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="marginTop" class="block text-xs font-medium text-slate-400 mb-1">Margin á›á¾</label>
                    <input type="number" id="marginTop" value="0" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label for="marginRight" class="block text-xs font-medium text-slate-400 mb-1">Margin áŸáŸ’áŠá¶áŸ†</label>
                    <input type="number" id="marginRight" value="0" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label for="marginBottom" class="block text-xs font-medium text-slate-400 mb-1">Margin á€áŸ’ášáŸ„á˜</label>
                    <input type="number" id="marginBottom" value="0" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label for="marginLeft" class="block text-xs font-medium text-slate-400 mb-1">Margin á†áŸ’áœáŸá„</label>
                    <input type="number" id="marginLeft" value="0" class="custom-input w-full rounded-lg p-2 text-sm">
                </div>
            </div>
        </div>

        <!-- Design Mode & Reset -->
        <div class="flex items-center justify-between mb-6 px-1">
            <label class="flex items-center cursor-pointer group select-none">
                <div class="relative">
                    <input type="checkbox" id="designModeToggle" class="sr-only">
                    <div class="block bg-slate-700 border border-slate-600 w-10 h-6 rounded-full group-hover:bg-slate-600 transition-colors"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform duration-200 ease-in-out"></div>
                </div>
                <span class="ml-3 text-sm font-medium text-slate-300">á€áŸ‚ášá…á“á¶á”á‘</span>
            </label>
            
            <button id="resetDesignButton" class="text-xs text-rose-400 hover:text-rose-500 font-medium underline decoration-dashed underline-offset-4 transition-colors">
                Reset á‘áŸ…áŠá¼á…áŠá¾á˜
            </button>
        </div>

        <style>
            #designModeToggle:checked ~ .block {
                background-color: #6366f1; /* Indigo */
                border-color: #6366f1;
            }
            #designModeToggle:checked ~ .dot {
                transform: translateX(100%);
            }
        </style>

        <!-- Buttons Control -->
        <div class="flex flex-col gap-3">
             <button id="guideButton" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-2.5 px-4 rounded-xl shadow-sm hover:shadow-md transition duration-300 flex items-center justify-center gap-2 border border-amber-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                á€á¶ášá€áŸ†áááŸ‹ Printer
            </button>

            <!-- Main Print Button -->
            <button id="printButton" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition duration-300 flex items-center justify-center gap-2 text-lg border border-indigo-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                Print Label
            </button>

            <!-- QR Print Button (Hidden by default, shown if map exists) -->
            <button id="printQRButton" class="hidden w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-teal-500/30 transition duration-300 items-center justify-center gap-2 border border-teal-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                Print QR Map
            </button>
        </div>
    </div>

    <!-- Modal (Print Guide) -->
    <div id="print-guide-modal" class="no-print flex">
        <div id="print-guide-content">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-white">á€á¶ášá€áŸ†áááŸ‹ Printer</h2>
                <button id="closeGuide" class="text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="bg-slate-900/50 border border-slate-700 p-4 rounded-lg mb-4">
                <ul class="space-y-2 text-sm text-slate-300">
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-primary">â€¢</span>
                        <span><strong>Destination:</strong> EML-200L (2 inch)</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-primary">â€¢</span>
                        <span><strong>Paper size:</strong> Custom / User Defined</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-primary">â€¢</span>
                        <span><strong>Margins:</strong> None (á”á·á‘ Margin)</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-primary">â€¢</span>
                        <span><strong>Background graphics:</strong> <span class="text-green-400 font-bold">ON</span> (áŸáŸ†áá¶á“áŸ‹!)</span>
                    </li>
                </ul>
            </div>
            <button id="closeGuideBtn" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors border border-slate-600">
                á™á›áŸ‹á á¾á™
            </button>
        </div>
    </div>

    <!-- Style Editor Panel -->
    <div id="styleEditor" class="no-print">
        <div class="flex justify-between items-center mb-3">
            <h4 id="editorTitle" class="text-sm font-bold text-slate-200">Edit Element</h4>
            <button id="closeEditor" class="text-slate-400 hover:text-rose-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div class="mb-2">
            <label class="block text-xs font-semibold text-slate-400 mb-1">Font Size (pt)</label>
            <div class="flex items-center gap-2">
                <input type="number" id="editorFontSize" class="custom-input w-full p-2 rounded-md text-sm" step="0.5">
                <span class="text-xs text-slate-500">pt</span>
            </div>
        </div>
    </div>


    <!-- ========================================= -->
    <!--           SIDE-BY-SIDE CONTAINER          -->
    <!-- ========================================= -->
    <div id="labels-wrapper" class="flex flex-wrap justify-center gap-8 items-start mb-8 w-full">
        
        <!-- LABEL 1: Main Information -->
        <div id="label-container" class="label-page">
            <div class="label-header editable-element" id="label-header-el">
                <span><span id="label-page">N/A</span></span>
                <span>User: <span id="label-user">N/A</span></span>
                <span>ID: <span id="label-order-id">ORD-XXXXX</span></span>
            </div>

            <div class="info-row" id="info-row-el">
                <div class="info-block left">
                    <div class="small-text editable-element" id="label-recipient-title">á¢áŸ’á“á€á‘á‘á½á› / Recipient:</div>
                    <div id="label-name" class="big-text editable-element">áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“</div>
                    <div id="label-phone" class="mt-0.5 editable-element">0xx xxx xxx</div>

                    <div class="small-text mt-1 editable-element" id="label-location-title">á‘á¸áá¶áŸ†á„ / Location:</div>
                    <div id="label-location" class="data-text editable-element">á—áŸ’á“áŸ†á–áŸá‰ááŸ’á˜á¸</div>

                    <div class="small-text mt-1 editable-element" id="label-address-title">á¢á¶áŸá™áŠáŸ’á‹á¶á“ / Address:</div>
                    <div id="label-address" class="data-text editable-element">(á˜á·á“á”á¶á“á”á‰áŸ’á‡á¶á€áŸ‹)</div>
                </div>

                <div class="info-block right">
                    <div class="small-text editable-element" id="label-date-title">á€á¶á›á”ášá·á…áŸ’á†áŸá‘:</div>
                    <div id="label-date" class="data-text editable-element">DD/MM/YYYY</div>

                    <div class="total-box editable-element" id="label-total-box">áá˜áŸ’á›áŸƒáŸášá»á”: <span id="label-total">$0.00</span></div>

                    <div class="small-text mt-1 editable-element" id="label-payment-title">áŸáŸ’áá¶á“á—á¶á–á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹:</div>
                    <div id="label-payment" class="data-text font-bold editable-element">Unpaid</div>

                    <div class="small-text mt-1 editable-element" id="label-shipping-title">áŠá¹á€á‡á‰áŸ’á‡á¼á“áŠáŸ„á™:</div>
                    <div id="label-shipping" class="data-text editable-element">N/A</div>
                    
                    <div id="label-cod" class="cod-tag editable-element hidden">COD (Cash on Delivery)</div>
                </div>
            </div>

            <div class="label-footer editable-element" id="label-footer-el">áŸá¼á˜áŠá¹á€á‡á‰áŸ’á‡á¼á“áŠáŸ„á™á”áŸ’ášá»á„á”áŸ’ášá™áŸááŸ’á“!</div>
        </div>

        <!-- LABEL 2: QR Code (Hidden) -->
        <div id="qr-label-container" class="label-page hidden">
            <!-- Title -->
            <h2 class="qr-title editable-element" id="qr-title-el">áŸáŸ’á€áŸá“á˜á¾á›á‘á¸áá¶áŸ†á„</h2>
            
            <!-- QR Code Render Target -->
            <div id="qrcode"></div>
            
            <!-- Footer Box -->
            <div class="qr-footer-box editable-element" id="qr-footer-el">Google Maps Link</div>
        </div>

    </div> 
    <!-- End Side-by-Side Container -->

    <!-- Audio Players -->
    <audio id="audioWelcome" src="welcome.mp3" preload="auto"></audio>
    <audio id="audioGuide" src="guide.mp3" preload="auto"></audio>
    <audio id="audioSuccess" src="success.mp3" preload="auto"></audio>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());
    
    // Audio elements
    const audioWelcome = document.getElementById('audioWelcome');
    const audioGuide = document.getElementById('audioGuide');
    const audioSuccess = document.getElementById('audioSuccess');

    // QR Size Input
    const qrSizeInput = document.getElementById('qrSizeInput');

    // *** Audio Management Logic ***
    let currentAudio = null;      
    let interruptedAudio = null;  

    function onAudioEnded() {
        if (interruptedAudio) {
            currentAudio = interruptedAudio;
            interruptedAudio = null;
            const promise = currentAudio.play(); 
            if (promise !== undefined) {
                promise.catch(error => {}).then(() => {});
            }
            currentAudio.removeEventListener('ended', onAudioEnded);
            currentAudio.addEventListener('ended', onAudioEnded, { once: true });
        } else {
            currentAudio = null;
        }
    }

    function playAudio(audioElement) {
        if (!audioElement) return;
        if (currentAudio && currentAudio !== audioElement && !currentAudio.paused) {
            currentAudio.pause();
            interruptedAudio = currentAudio; 
        } else if (!currentAudio || currentAudio !== audioElement) {
            interruptedAudio = null; 
        }
        currentAudio = audioElement;
        if (currentAudio.currentTime > 0 && currentAudio === interruptedAudio) {
        } else {
            currentAudio.currentTime = 0; 
        }
        const promise = currentAudio.play();
        if (promise !== undefined) {
            promise.catch(error => {}).then(() => {});
        }
        currentAudio.removeEventListener('ended', onAudioEnded); 
        currentAudio.addEventListener('ended', onAudioEnded, { once: true }); 
    }

    // Helper to Generate QR
    function generateQR(size) {
        if (params.map) {
             const mapUrl = decodeURIComponent(params.map);
             const qrDiv = document.getElementById('qrcode');
             qrDiv.innerHTML = ""; // Clear old
             
             // Ensure size is valid number
             const validSize = parseInt(size) || 100;
             
             new QRCode(qrDiv, {
                text: mapUrl,
                width: validSize,
                height: validSize,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }
    }

    // Update QR on Input Change
    qrSizeInput.addEventListener('input', (e) => {
        generateQR(e.target.value);
    });

    if (params.id) {
        // Fill Data
        document.getElementById('label-page').textContent = params.page || 'N/A';
        document.getElementById('label-user').textContent = params.user || 'N/A';
        document.getElementById('label-order-id').textContent = params.id || 'N/A';
        document.getElementById('label-name').textContent = params.name || 'N/A';
        document.getElementById('label-phone').textContent = params.phone || 'N/A';
        document.getElementById('label-location').textContent = params.location || 'N/A';
        document.getElementById('label-address').textContent = params.address || '(á˜á·á“á”á¶á“á”á‰áŸ’á‡á¶á€áŸ‹)';
        document.getElementById('label-total').textContent = params.total ? `$${parseFloat(params.total).toFixed(2)}` : 'N/A';
        document.getElementById('label-payment').textContent = params.payment || 'Unpaid';
        document.getElementById('label-shipping').textContent = params.shipping || 'N/S';

        // COD Logic
        const paymentStatus = params.payment ? params.payment.toLowerCase() : 'unpaid';
        const codElement = document.getElementById('label-cod');
        if (codElement) {
            if (paymentStatus === 'unpaid') {
                codElement.classList.remove('hidden');
                codElement.textContent = 'COD (Cash on Delivery)';
            } else {
                codElement.classList.add('hidden');
            }
        }

        // ===============================================
        // NEW: QR Code Logic (Check for 'map' param)
        // ===============================================
        if (params.map) {
            const qrContainer = document.getElementById('qr-label-container');
            const qrButton = document.getElementById('printQRButton');
            
            // 1. Show the QR Label Container (Preview)
            qrContainer.classList.remove('hidden');
            
            // 2. Show the Print QR Button
            qrButton.classList.remove('hidden');
            qrButton.classList.add('flex'); 

            // 4. Generate the QR Code (Initial size 100)
            generateQR(100);
        }
        // ===============================================

        const today = new Date();
        const d = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        document.getElementById('label-date').textContent = d;

        const playWelcomeOnFirstInteraction = () => {
            playAudio(audioWelcome);
        };
        document.body.addEventListener('click', playWelcomeOnFirstInteraction, { once: true });
        document.body.addEventListener('touchstart', playWelcomeOnFirstInteraction, { once: true });
    }

    // ===============================================
    // PRINT LOGIC (Handle Single Label Printing)
    // ===============================================
    function printSpecificLabel(containerIdToPrint) {
        // Find all label pages
        const allLabels = document.querySelectorAll('.label-page');
        
        // Loop through and hide the ones NOT being printed
        allLabels.forEach(label => {
            if (label.id !== containerIdToPrint) {
                label.classList.add('hidden-on-print');
            } else {
                label.classList.remove('hidden-on-print');
            }
        });

        // Trigger Print
        window.print();

        // Remove hidden classes after print dialogue closes (so preview returns to normal)
        allLabels.forEach(label => {
            label.classList.remove('hidden-on-print');
        });

        setTimeout(() => {
            playAudio(audioSuccess);
        }, 1000); 
    }

    // Button: Print MAIN Label
    document.getElementById('printButton').addEventListener('click', () => {
        printSpecificLabel('label-container');
    });

    // Button: Print QR Code
    document.getElementById('printQRButton').addEventListener('click', () => {
        printSpecificLabel('qr-label-container');
    });
    // ===============================================


    // Guide modal logic
    const guideBtn = document.getElementById('guideButton');
    const guideModal = document.getElementById('print-guide-modal');
    const closeGuide = document.getElementById('closeGuide');
    const closeGuideBtn = document.getElementById('closeGuideBtn');

    function hideGuide() {
        if (currentAudio && currentAudio === audioGuide) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            onAudioEnded(); 
        }
        guideModal.style.display = 'none';
    }

    guideBtn.addEventListener('click', () => {
        playAudio(audioGuide);
        guideModal.style.display = 'flex';
    });
    
    closeGuide.addEventListener('click', hideGuide);
    closeGuideBtn.addEventListener('click', hideGuide);

    // Label Size Logic (Updates ALL .label-page elements)
    const rootStyle = document.documentElement.style;
    const sizeRadios = document.querySelectorAll('input[name="label_size"]');
    const customInputsDiv = document.getElementById('custom-size-inputs');
    const customWidthInput = document.getElementById('customWidth');
    const customHeightInput = document.getElementById('customHeight');
    const labelContainers = document.querySelectorAll('.label-page'); // Select ALL labels
    const standardRatio = 78 / 50; 
    let isUpdating = false; 

    function updateLabelSize(width, height) {
        if (isUpdating) return;
        rootStyle.setProperty('--page-width', `${width}mm`);
        rootStyle.setProperty('--page-height', `${height}mm`);
        
        // Update pixel dimensions for screen preview
        const pixelWidth = width * 3.7795275591;
        const pixelHeight = height * 3.7795275591;
        
        labelContainers.forEach(container => {
            container.style.width = `${pixelWidth}px`;
            container.style.height = `${pixelHeight}px`;
        });
    }

    sizeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'standard') {
                customInputsDiv.classList.add('hidden');
                customWidthInput.value = 78;
                customHeightInput.value = 50;
                updateLabelSize(78, 50);
            } else {
                customInputsDiv.classList.remove('hidden');
            }
        });
    });
    customWidthInput.addEventListener('input', (e) => {
        isUpdating = true;
        const width = parseFloat(e.target.value) || 0;
        const height = width / standardRatio;
        customHeightInput.value = height.toFixed(2);
        updateLabelSize(width, height);
        isUpdating = false;
    });
    customHeightInput.addEventListener('input', (e) => {
        isUpdating = true;
        const height = parseFloat(e.target.value) || 0;
        const width = height * standardRatio;
        customWidthInput.value = width.toFixed(2);
        updateLabelSize(width, height);
        isUpdating = false;
    });

    // Margin Logic
    const marginInputs = [
        { id: 'marginTop', key: '--page-margin-top' },
        { id: 'marginRight', key: '--page-margin-right' },
        { id: 'marginBottom', key: '--page-margin-bottom' },
        { id: 'marginLeft', key: '--page-margin-left' }
    ];
    marginInputs.forEach(margin => {
        const savedValue = localStorage.getItem(margin.key);
        if (savedValue !== null) {
            const valueInMm = `${savedValue || 0}mm`;
            rootStyle.setProperty(margin.key, valueInMm);
            document.getElementById(margin.id).value = savedValue || 0;
        }
    });
    marginInputs.forEach(margin => {
        document.getElementById(margin.id).addEventListener('input', (e) => {
            const value = e.target.value || 0;
            const valueInMm = `${value}mm`;
            rootStyle.setProperty(margin.key, valueInMm);
            localStorage.setItem(margin.key, value);
        });
    });

    // Design Mode Logic
    const designModeToggle = document.getElementById('designModeToggle');
    const styleEditor = document.getElementById('styleEditor');
    const editorTitle = document.getElementById('editorTitle');
    const editorFontSize = document.getElementById('editorFontSize');
    const closeEditorBtn = document.getElementById('closeEditor');
    const editableElements = document.querySelectorAll('.editable-element');
    const STYLES_KEY = 'labelStyles';

    const resetDesignButton = document.getElementById('resetDesignButton');
    resetDesignButton.addEventListener('click', () => {
        if(confirm('áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á€áŸ†áááŸ‹ášá…á“á¶á”á‘á¡á¾á„áœá·á‰á˜áŸ‚á“á‘áŸ?')) {
            localStorage.removeItem(STYLES_KEY);
            window.location.reload();
        }
    });

    let isDesignMode = false;
    let selectedElement = null;

    function loadAllStyles() {
        const savedStyles = JSON.parse(localStorage.getItem(STYLES_KEY) || '{}');
        editableElements.forEach(el => {
            const style = savedStyles['#' + el.id];
            if (style) {
                el.style.fontSize = style.fontSize;
            }
        });
    }

    function saveStyle(element) {
        if (!element) return;
        const savedStyles = JSON.parse(localStorage.getItem(STYLES_KEY) || '{}');
        const styleData = { fontSize: element.style.fontSize };
        let existingStyle = savedStyles['#' + element.id] || {};
        existingStyle.fontSize = styleData.fontSize; 
        savedStyles['#' + element.id] = existingStyle;
        localStorage.setItem(STYLES_KEY, JSON.stringify(savedStyles));
    }

    function showEditor(element) {
        selectedElement = element;
        editableElements.forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        styleEditor.style.bottom = '20px'; // Higher up
        editorTitle.textContent = `Edit: #${element.id}`;
        let currentSize = element.style.fontSize;
        if (!currentSize) {
            currentSize = window.getComputedStyle(element).fontSize;
        }
        editorFontSize.value = parseFloat(currentSize);
    }

    function hideEditor() {
        styleEditor.style.bottom = '-200px'; 
        if (selectedElement) {
            selectedElement.classList.remove('selected');
        }
        selectedElement = null;
    }

    editableElements.forEach(el => {
        el.addEventListener('click', (ev) => {
            if (!isDesignMode) return;
            showEditor(el);
            ev.stopPropagation(); // Prevent clicking through
        });
    });

    designModeToggle.addEventListener('change', (e) => {
        isDesignMode = e.target.checked;
        labelContainers.forEach(container => {
             if (isDesignMode) {
                container.classList.add('design-mode-active');
            } else {
                container.classList.remove('design-mode-active');
            }
        });
        if (!isDesignMode) hideEditor();
    });

    closeEditorBtn.addEventListener('click', hideEditor);
    editorFontSize.addEventListener('input', (e) => {
        if (selectedElement) {
            const newSize = parseFloat(e.target.value) || 10;
            selectedElement.style.fontSize = `${newSize}pt`;
            saveStyle(selectedElement);
        }
    });

    // Close editor when clicking outside
    document.addEventListener('click', (e) => {
        if (isDesignMode && selectedElement && !e.target.closest('.editable-element') && !e.target.closest('#styleEditor')) {
            hideEditor();
        }
    });

    loadAllStyles();

});
</script>

</body>
</html>
