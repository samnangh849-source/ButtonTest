<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Printer (78x50mm)</title>
    <!-- Import Font Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Variables សម្រាប់គ្រប់គ្រងទំហំ និង Margin */
        :root {
            --page-width: 78mm;
            --page-height: 50mm;
            --page-margin-top: 0mm;
            --page-margin-right: 0mm;
            --page-margin-bottom: 0mm;
            --page-margin-left: 0mm;
        }

        html, body {
            box-sizing: border-box;
            /* ប្រើ Font Kantumruy Pro */
            font-family: 'Kantumruy Pro', 'Arial', 'Inter', sans-serif;
            color: #000; /* ពណ៌អក្សរគោល ខ្មៅ */
        }
        *, *:before, *:after { box-sizing: inherit; }

        #label-container {
            /* ប្រើ CSS Variable សម្រាប់ទំហំ */
            width: var(--page-width); 
            height: var(--page-height);
            background-color: white;
            margin: 0 auto;
            /* គម្លាត 1mm លើក្រោម, 3mm ឆ្វេងស្តាំ */
            padding: 1mm 3mm; 
            display: flex; /* This will be overridden by JS if styles are loaded */
            flex-direction: column;
            justify-content: space-between;
            font-size: 8pt;
            line-height: 1.15;
            overflow: hidden;
            border: 1px dashed #ccc;
            position: relative; /* *** NEW: Required for absolute positioning *** */
        }

        .label-header {
            border-bottom: 1px dashed #000;
            display: flex;
            justify-content: space-between;
            font-size: 7pt;
            font-weight: 500; /* Medium weight */
            padding-bottom: 1mm;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
            gap: 1mm;
            padding-top: 0.5mm;
            padding-bottom: 0.5mm;
        }

        .info-block { flex: 1; }
        .info-block.right {
            text-align: right;
            border-left: 1px dashed #ccc;
            padding-left: 1mm;
            width: 40%;
        }
        .info-block.left { width: 60%; }

        /* Label (អក្សរចំណងជើងតូច) */
        .small-text { 
            font-size: 7pt; 
            font-weight: 500; /* Medium */
            color: #333; /* ប្រើពណ៌ខ្មៅស្រាលបន្តិច ជំនួសប្រផេះ */
        }
        
        /* Data (ទិន្នន័យ) */
        .big-text { font-size: 10pt; font-weight: 700; } /* ឈ្មោះ */
        #label-phone { font-size: 11pt; font-weight: 700; } /* លេខទូរស័ព្ទ */
        #label-location { font-size: 11pt; font-weight: 700; } /* ទីតាំង */
        .data-text { font-size: 9pt; font-weight: 700; } /* ទិន្នន័យផ្សេងទៀត */

        .total-box {
            background-color: #f0f0f0; /* ពណ៌ផ្ទៃប្រផេះស្រាល */
            color: #000;
            padding: 0.5mm;
            border-radius: 0.125rem;
            font-weight: 700;
            font-size: 10pt;
            margin-top: 0.5mm;
        }
        #label-total { font-size: 10pt; } /* ទំហំតម្លៃសរ uš */

        .label-footer {
            border-top: 1px dashed #000;
            text-align: center;
            font-size: 7pt;
            font-weight: 700; /* Bold */
            padding-top: 1mm;
        }

        /* ---------------- PRINT STYLES ---------------- */
        @page {
            /* ប្រើ CSS Variables សម្រាប់ទំហំ និង Margin ពេល Print */
            size: var(--page-width) var(--page-height);
            margin-top: var(--page-margin-top);
            margin-right: var(--page-margin-right);
            margin-bottom: var(--page-margin-bottom);
            margin-left: var(--page-margin-left);
        }

        @media print {
            html, body {
                width: var(--page-width);
                height: var(--page-height);
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
            }

            #label-container {
                width: 100%;
                height: 100%;
                margin: 0 !important;
                padding: 1mm 3mm !important; /* រក្សាគម្លាតពេល Print */
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                page-break-after: always;
            }

            .no-print { display: none !important; }
            #styleEditor { display: none !important; } /* *** NEW: Hide editor when printing *** */
        }
        /* ---------------- END PRINT STYLES ---------------- */


        body { background-color: #f0f4f8; padding: 1rem; }

        /* Modal Styling */
        #print-guide-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        #print-guide-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* *** NEW: Design Mode Styles *** */
        .editable-element {
            cursor: default;
            transition: outline 0.1s ease-in-out;
        }
        .design-mode-active .editable-element {
            cursor: move; /* 'move' cursor when editable */
        }
        .editable-element.selected {
            outline: 2px dashed #007bff; /* Highlight selected */
            z-index: 10;
        }
        #styleEditor {
            position: fixed; /* Use fixed to float over everything */
            z-index: 1001;
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
            display: none; /* Hidden by default */
        }
        /* *** END: Design Mode Styles *** */

    </style>
</head>
<body>

    <!-- UI មុនព្រីន -->
    <div class="no-print max-w-sm mx-auto p-4 bg-white rounded-lg shadow-lg mb-6 text-center">
        <h1 class="text-xl font-bold text-gray-800 mb-2">ទម្រង់ព្រីន Label</h1>
        <p class="text-sm text-gray-600 mb-4">ទំហំគោល (78mm x 50mm)</p>

        <!-- ជម្រើសទំហំ Label -->
        <div class="border-t border-b border-gray-200 py-4 my-4">
            <h2 class="text-md font-bold text-gray-700 mb-3 text-left">ជម្រើសទំហំ Label (mm)</h2>
            <div class="flex items-center gap-6 mb-3">
                <label class="flex items-center">
                    <input type="radio" name="label_size" value="standard" checked class="form-radio">
                    <span class="ml-2 text-sm">Standard (78x50)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="label_size" value="custom" class="form-radio">
                    <span class="ml-2 text-sm">Customize</span>
                </label>
            </div>
            <!-- ช่อง Custom -->
            <div id="custom-size-inputs" class="hidden grid grid-cols-2 gap-3">
                <div>
                    <label for="customWidth" class="block text-xs font-medium text-gray-600 text-left mb-1">ទទឹង (Width)</label>
                    <input type="number" id="customWidth" value="78" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="customHeight" class="block text-xs font-medium text-gray-600 text-left mb-1">បណ្ដោយ (Height)</label>
                    <input type="number" id="customHeight" value="50" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
            </div>
        </div>

        <!-- កំណត់ Margins -->
        <div class="border-b border-gray-200 pb-4 mb-4">
            <h2 class="text-md font-bold text-gray-700 mb-3 text-left">កំណត់ Margins បោះពុម្ព (mm)</h2>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="marginTop" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin លើ (Top)</label>
                    <input type="number" id="marginTop" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="marginRight" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin ស្ដាំ (Right)</label>
                    <input type="number" id="marginRight" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="marginBottom" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin ក្រោម (Bottom)</label>
                    <input type="number" id="marginBottom" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="marginLeft" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin ឆ្វេង (Left)</label>
                    <input type="number" id="marginLeft" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
            </div>
        </div>

        <!-- *** Design Mode Toggle *** -->
        <div class="border-b border-gray-200 pb-4 mb-4">
            <h2 class="text-md font-bold text-gray-700 mb-3 text-left">โหมดออกแบบ (Design Mode)</h2>
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="designModeToggle" class="form-checkbox h-5 w-5 text-blue-600">
                <!-- *** CHANGED (Request 1) *** -->
                <span class="ml-2 text-sm text-gray-700">កែរចនាបទ Label</span>
            </label>
        </div>
        <!-- *** END: Design Mode Toggle *** -->

        <!-- *** NEW (Request 2) *** -->
        <div class="border-b border-gray-200 pb-4 mb-4">
            <button id="resetDesignButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                Reset រចនាបទ ទៅដូចដើម
            </button>
        </div>
        <!-- *** END: Reset Button *** -->


        <div class="flex flex-col gap-2">
            <button id="guideButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                ព័ត៌មានបោះពុម្ព(ការកំណត់)
            </button>

            <button id="printButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300">
                Print Label
            </button>
        </div>
    </div>

    <!-- Modal (Print Guide) -->
    <div id="print-guide-modal" class="no-print flex">
        <div id="print-guide-content">
            <h2 class="text-lg font-bold mb-2 text-gray-800">ការកំណត់ Printer ត្រឹមត្រូវ</h2>
            <ul class="list-disc pl-5 text-sm text-gray-700 mb-4 text-left">
                <li>ជ្រើស <strong>Destination:</strong> EML-200L (2 inch)</li>
                <li><strong>Paper size:</strong> Custom (ប្រើទំហំដែលបានកំណត់)</li>
                <li><strong>Margins:</strong> None (ឬ ប្រើ Custom Margins)</li>
                <li><strong>Background graphics:</strong> ON</li>
            </ul>
            <button id="closeGuide" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full">បិទ</button>
        </div>
    </div>

    <!-- *** NEW: Style Editor Panel *** -->
    <div id="styleEditor" class="no-print">
        <div class="flex justify-between items-center mb-2">
            <h4 id="editorTitle" class="text-sm font-bold">Edit Element</h4>
            <button id="closeEditor" class="text-xl font-bold text-red-500 leading-none">&times;</button>
        </div>
        <div class="mb-2">
            <label class="block text-xs mb-1">Font Size (pt)</label>
            <input type="number" id="editorFontSize" class="w-full border border-gray-300 p-1 rounded" step="0.5">
        </div>
    </div>
    <!-- *** END: Style Editor Panel *** -->


    <!-- Label Container -->
    <div id="label-container">
        <!-- *** NEW: Added 'editable-element' class and unique IDs to all text elements *** -->
        <div class="label-header editable-element" id="label-header-el">
            <span>Page: <span id="label-page">N/A</span></span>
            <span>User: <span id="label-user">N/A</span></span>
            <span>ID: <span id="label-order-id">ORD-XXXXX</span></span>
        </div>

        <div class="info-row" id="info-row-el"> <!-- This container itself is not editable -->
            <div class="info-block left">
                <div class="small-text editable-element" id="label-recipient-title">អ្នកទទួល / Recipient:</div>
                <div id="label-name" class="big-text editable-element">ឈ្មោះអតិថិជន</div>
                <div id="label-phone" class="mt-0.5 editable-element">0xx xxx xxx</div>

                <div class="small-text mt-1 editable-element" id="label-location-title">ទីតាំង / Location:</div>
                <div id="label-location" class="data-text editable-element">ភ្នំពេញថ្មី</div>

                <div class="small-text mt-1 editable-element" id="label-address-title">អាសយដ្ឋាន / Address:</div>
                <div id="label-address" class="data-text editable-element">(មិនបានបញ្ជាក់)</div>
            </div>

            <div class="info-block right">
                <div class="small-text editable-element" id="label-date-title">កាលបរិច្ឆេទ:</div>
                <div id="label-date" class="data-text editable-element">DD/MM/YYYY</div>

                <div class="total-box editable-element" id="label-total-box">តម្លៃសរុប: <span id="label-total">$0.00</span></div>

                <div class="small-text mt-1 editable-element" id="label-payment-title">ស្ថានភាពបង់ប្រាក់:</div>
                <div id="label-payment" class="data-text font-bold editable-element">Unpaid</div>

                <div class="small-text mt-1 editable-element" id="label-shipping-title">ដឹកជញ្ជូនដោយ:</div>
                <div id="label-shipping" class="data-text editable-element">N/A</div>
            </div>
        </div>

        <div class="label-footer editable-element" id="label-footer-el">សូមដឹកជញ្ជូនដោយប្រុងប្រយ័ត្ន!</div>
    </div>

    <!-- Audio Players -->
    <audio id="audioWelcome" src="welcome.mp3" preload="auto"></audio>
    <audio id="audioGuide" src="guide.mp3" preload="auto"></audio>
    <audio id="audioSuccess" src="success.mp3" preload="auto"></audio>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());
    
    // Audio elements
    const audioWelcome = document.getElementById('audioWelcome');
    const audioGuide = document.getElementById('audioGuide');
    const audioSuccess = document.getElementById('audioSuccess');

    // *** Audio Management Logic ***
    let currentAudio = null;      
    let interruptedAudio = null;  

    function onAudioEnded() {
        if (interruptedAudio) {
            currentAudio = interruptedAudio;
            interruptedAudio = null;
            const promise = currentAudio.play(); 
            if (promise !== undefined) {
                promise.catch(error => {}).then(() => {});
            }
            currentAudio.removeEventListener('ended', onAudioEnded);
            currentAudio.addEventListener('ended', onAudioEnded, { once: true });
        } else {
            currentAudio = null;
        }
    }

    function playAudio(audioElement) {
        if (!audioElement) return;
        if (currentAudio && currentAudio !== audioElement && !currentAudio.paused) {
            currentAudio.pause();
            interruptedAudio = currentAudio; 
        } else if (!currentAudio || currentAudio !== audioElement) {
            interruptedAudio = null; 
        }
        currentAudio = audioElement;
        if (currentAudio.currentTime > 0 && currentAudio === interruptedAudio) {
        } else {
            currentAudio.currentTime = 0; 
        }
        const promise = currentAudio.play();
        if (promise !== undefined) {
            promise.catch(error => {}).then(() => {});
        }
        currentAudio.removeEventListener('ended', onAudioEnded); 
        currentAudio.addEventListener('ended', onAudioEnded, { once: true }); 
    }
    // *** END: Audio Management Logic ***


    if (params.id) {
        document.getElementById('label-page').textContent = params.page || 'N/A';
        document.getElementById('label-user').textContent = params.user || 'N/A';
        document.getElementById('label-order-id').textContent = params.id || 'N/A';
        document.getElementById('label-name').textContent = params.name || 'N/A';
        document.getElementById('label-phone').textContent = params.phone || 'N/A';
        document.getElementById('label-location').textContent = params.location || 'N/A';
        document.getElementById('label-address').textContent = params.address || '(មិនបានបញ្ជាក់)';
        document.getElementById('label-total').textContent = params.total ? `$${parseFloat(params.total).toFixed(2)}` : 'N/A';
        document.getElementById('label-payment').textContent = params.payment || 'Unpaid';
        document.getElementById('label-shipping').textContent = params.shipping || 'N/A';

        const today = new Date();
        const d = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        document.getElementById('label-date').textContent = d;

        const playWelcomeOnFirstInteraction = () => {
            playAudio(audioWelcome);
        };
        document.body.addEventListener('click', playWelcomeOnFirstInteraction, { once: true });
        document.body.addEventListener('touchstart', playWelcomeOnFirstInteraction, { once: true });
    }

    // Print button
    document.getElementById('printButton').addEventListener('click', () => {
        window.print();
        setTimeout(() => {
            playAudio(audioSuccess);
        }, 40000); 
    });

    // Guide modal
    const guideBtn = document.getElementById('guideButton');
    const guideModal = document.getElementById('print-guide-modal');
    const closeGuide = document.getElementById('closeGuide');

    guideBtn.addEventListener('click', () => {
        playAudio(audioGuide);
        guideModal.style.display = 'flex';
    });
    
    closeGuide.addEventListener('click', () => {
        if (currentAudio && currentAudio === audioGuide) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            onAudioEnded(); 
        }
        guideModal.style.display = 'none';
    });

    // ------------------- Label Size Logic -------------------
    const rootStyle = document.documentElement.style;
    const sizeRadios = document.querySelectorAll('input[name="label_size"]');
    const customInputsDiv = document.getElementById('custom-size-inputs');
    const customWidthInput = document.getElementById('customWidth');
    const customHeightInput = document.getElementById('customHeight');
    const labelContainer = document.getElementById('label-container');
    const standardRatio = 78 / 50; 
    let isUpdating = false; 

    function updateLabelSize(width, height) {
        if (isUpdating) return;
        rootStyle.setProperty('--page-width', `${width}mm`);
        rootStyle.setProperty('--page-height', `${height}mm`);
        labelContainer.style.width = `${width * 3.7795275591}px`;
        labelContainer.style.height = `${height * 3.7795275591}px`;
    }
    sizeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'standard') {
                customInputsDiv.classList.add('hidden');
                customWidthInput.value = 78;
                customHeightInput.value = 50;
                updateLabelSize(78, 50);
            } else {
                customInputsDiv.classList.remove('hidden');
            }
        });
    });
    customWidthInput.addEventListener('input', (e) => {
        isUpdating = true;
        const width = parseFloat(e.target.value) || 0;
        const height = width / standardRatio;
        customHeightInput.value = height.toFixed(2);
        updateLabelSize(width, height);
        isUpdating = false;
    });
    customHeightInput.addEventListener('input', (e) => {
        isUpdating = true;
        const height = parseFloat(e.target.value) || 0;
        const width = height * standardRatio;
        customWidthInput.value = width.toFixed(2);
        updateLabelSize(width, height);
        isUpdating = false;
    });

    // ------------------- Margin Logic -------------------
    const marginInputs = [
        { id: 'marginTop', key: '--page-margin-top' },
        { id: 'marginRight', key: '--page-margin-right' },
        { id: 'marginBottom', key: '--page-margin-bottom' },
        { id: 'marginLeft', key: '--page-margin-left' }
    ];
    marginInputs.forEach(margin => {
        const savedValue = localStorage.getItem(margin.key);
        if (savedValue !== null) {
            const valueInMm = `${savedValue || 0}mm`;
            rootStyle.setProperty(margin.key, valueInMm);
            document.getElementById(margin.id).value = savedValue || 0;
        }
    });
    marginInputs.forEach(margin => {
        document.getElementById(margin.id).addEventListener('input', (e) => {
            const value = e.target.value || 0;
            const valueInMm = `${value}mm`;
            rootStyle.setProperty(margin.key, valueInMm);
            localStorage.setItem(margin.key, value);
        });
    });


    // ------------------- *** Design Mode Logic *** -------------------
    const designModeToggle = document.getElementById('designModeToggle');
    const styleEditor = document.getElementById('styleEditor');
    const editorTitle = document.getElementById('editorTitle');
    const editorFontSize = document.getElementById('editorFontSize');
    const closeEditorBtn = document.getElementById('closeEditor');
    const editableElements = document.querySelectorAll('.editable-element');
    const STYLES_KEY = 'labelStyles';

    // *** NEW (Request 2): Reset Button Listener ***
    const resetDesignButton = document.getElementById('resetDesignButton');
    resetDesignButton.addEventListener('click', () => {
        localStorage.removeItem(STYLES_KEY);
        window.location.reload();
    });

    let isDesignMode = false;
    let selectedElement = null;
    let isDragging = false;
    let offsetX, offsetY;

    // 1. Load Saved Styles on Page Load
    function loadAllStyles() {
        const savedStyles = JSON.parse(localStorage.getItem(STYLES_KEY) || '{}');
        if (Object.keys(savedStyles).length === 0) {
            return; // No saved styles, use default flex layout
        }

        // If styles exist, force absolute positioning
        labelContainer.style.display = 'block'; // Override flex
        document.getElementById('info-row-el').style.display = 'block';
        
        editableElements.forEach(el => {
            const style = savedStyles['#' + el.id];
            if (style) {
                el.style.position = 'absolute';
                el.style.top = style.top;
                el.style.left = style.left;
                el.style.fontSize = style.fontSize;
            }
        });
    }

    // 2. Save Style for a Specific Element
    function saveStyle(element) {
        if (!element) return;
        const savedStyles = JSON.parse(localStorage.getItem(STYLES_KEY) || '{}');
        
        const styleData = {
            top: element.style.top,
            left: element.style.left,
            fontSize: element.style.fontSize
        };
        savedStyles['#' + element.id] = styleData;
        localStorage.setItem(STYLES_KEY, JSON.stringify(savedStyles));
    }

    // 3. Convert from Flex to Absolute (Run ONCE when first edit occurs)
    function convertToAbsolute() {
        // *** MODIFIED (Request 3): Check if already converted ***
        if (localStorage.getItem(STYLES_KEY)) return; // Already converted

        labelContainer.style.display = 'block'; // Override flex
        document.getElementById('info-row-el').style.display = 'block';

        const savedStyles = {};
        const parentRect = labelContainer.getBoundingClientRect();

        editableElements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const top = rect.top - parentRect.top;
            const left = rect.left - parentRect.left;
            const fontSize = window.getComputedStyle(el).fontSize;

            el.style.position = 'absolute';
            el.style.top = `${top}px`;
            el.style.left = `${left}px`;
            
            savedStyles['#' + el.id] = {
                top: `${top}px`,
                left: `${left}px`,
                fontSize: fontSize
            };
        });
        localStorage.setItem(STYLES_KEY, JSON.stringify(savedStyles));
    }

    // 4. Show/Hide Style Editor
    function showEditor(element) {
        selectedElement = element;
        editableElements.forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');

        const rect = element.getBoundingClientRect();
        styleEditor.style.display = 'block';
        // Position editor above the element
        let editorTop = window.scrollY + rect.top - styleEditor.offsetHeight - 10;
        if (editorTop < window.scrollY + 10) { // If it goes off-screen top
            editorTop = window.scrollY + rect.bottom + 10; // Position below
        }
        styleEditor.style.top = `${editorTop}px`;
        styleEditor.style.left = `${window.scrollX + rect.left}px`;

        editorTitle.textContent = `Edit: #${element.id}`;
        editorFontSize.value = parseFloat(window.getComputedStyle(element).fontSize);
    }

    function hideEditor() {
        styleEditor.style.display = 'none';
        if (selectedElement) {
            selectedElement.classList.remove('selected');
        }
        selectedElement = null;
    }

    // 5. Drag and Drop Event Handlers
    function onDragStart(e) {
        if (!isDesignMode || !selectedElement) return;
        isDragging = true;
        
        let event = e.touches ? e.touches[0] : e;
        offsetX = event.clientX - selectedElement.getBoundingClientRect().left;
        offsetY = event.clientY - selectedElement.getBoundingClientRect().top;
        
        // Prevent text selection
        e.preventDefault();
    }

    function onDrag(e) {
        if (!isDragging || !selectedElement) return;

        let event = e.touches ? e.touches[0] : e;
        const parentRect = labelContainer.getBoundingClientRect();

        let newLeft = event.clientX - parentRect.left - offsetX;
        let newTop = event.clientY - parentRect.top - offsetY;

        // Snap to grid or boundaries (optional, simple version here)
        newLeft = Math.max(0, Math.min(newLeft, parentRect.width - selectedElement.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, parentRect.height - selectedElement.offsetHeight));

        selectedElement.style.left = `${newLeft}px`;
        selectedElement.style.top = `${newTop}px`;
    }

    function onDragEnd(e) {
        if (isDragging) {
            saveStyle(selectedElement); // Save the final position
        }
        isDragging = false;
    }

    // 6. Main Toggle Logic
    designModeToggle.addEventListener('change', (e) => {
        isDesignMode = e.target.checked;
        if (isDesignMode) {
            labelContainer.classList.add('design-mode-active');
            
            // *** REMOVED convertToAbsolute() call (Request 3) ***

            editableElements.forEach(el => {
                const handleEditStart = (ev) => {
                    if (!isDesignMode) return;

                    // *** NEW LOGIC (Request 3) ***
                    // Check if this is the first edit. If so, convert layout.
                    if (!localStorage.getItem(STYLES_KEY)) {
                        convertToAbsolute();
                    }
                    
                    showEditor(el);
                    onDragStart(ev);
                };

                el.addEventListener('mousedown', handleEditStart);
                el.addEventListener('touchstart', handleEditStart, { passive: false });
            });
            
            window.addEventListener('mousemove', onDrag);
            window.addEventListener('touchmove', onDrag, { passive: false });
            
            window.addEventListener('mouseup', onDragEnd);
            window.addEventListener('touchend', onDragEnd);

        } else {
            labelContainer.classList.remove('design-mode-active');
            hideEditor();
            window.location.reload(); 
        }
    });

    // 7. Editor Listeners
    closeEditorBtn.addEventListener('click', hideEditor);
    editorFontSize.addEventListener('input', (e) => {
        if (selectedElement) {
            // *** NEW LOGIC (Request 3) ***
            // Check if this is the first edit. If so, convert layout.
            if (!localStorage.getItem(STYLES_KEY)) {
                convertToAbsolute();
            }
            
            const newSize = parseFloat(e.target.value) || 10;
            selectedElement.style.fontSize = `${newSize}pt`;
            saveStyle(selectedElement);
        }
    });

    // 8. Initial Load
    loadAllStyles();

});
</script>

</body>
</html>

