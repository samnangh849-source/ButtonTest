<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Printer (78x50mm) + QR</title>
    <!-- Import Font Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import QRCode.js សម្រាប់បង្កើត QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* CSS Variables សម្រាប់គ្រប់គ្រងទំហំ និង Margin */
        :root {
            --page-width: 78mm;
            --page-height: 50mm;
            --page-margin-top: 0mm;
            --page-margin-right: 0mm;
            --page-margin-bottom: 0mm;
            --page-margin-left: 0mm;
        }

        html, body {
            box-sizing: border-box;
            font-family: 'Kantumruy Pro', 'Arial', 'Inter', sans-serif;
            color: #000;
        }
        *, *:before, *:after { box-sizing: inherit; }

        /* --- STYLES សម្រាប់ Label ទាំងអស់ (ទាំង Label ដើម និង QR) --- */
        .label-page {
            width: var(--page-width); 
            height: var(--page-height);
            background-color: white;
            margin: 0 auto;
            padding: 1mm 3mm; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 8pt;
            line-height: 1.15;
            overflow: hidden;
            border: 1px dashed #ccc;
            position: relative;
            
            /* បន្ថែម margin-bottom ដើម្បីអោយមានគម្លាតរវាង Label ទាំងពីរពេលមើលលើអេក្រង់ */
            margin-bottom: 20px; 
        }

        /* --- Styles សម្រាប់ Label ព័ត៌មាន (Label ដើម) --- */
        .label-header {
            border-bottom: 1px dashed #000;
            display: flex;
            justify-content: space-between;
            font-size: 7pt;
            font-weight: 500;
            padding-bottom: 1mm;
            width: 100%;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
            gap: 1mm;
            padding-top: 0.5mm;
            padding-bottom: 0.5mm;
            width: 100%;
        }

        .info-block { flex: 1; }
        .info-block.right {
            text-align: right;
            border-left: 1px dashed #ccc;
            padding-left: 1mm;
            width: 40%;
        }
        .info-block.left { width: 60%; }

        .small-text { 
            font-size: 7pt; 
            font-weight: 500; 
            color: #333; 
        }
        
        .big-text { font-size: 10pt; font-weight: 700; } 
        #label-phone { font-size: 11pt; font-weight: 700; } 
        #label-location { font-size: 11pt; font-weight: 700; } 
        .data-text { font-size: 9pt; font-weight: 700; } 

        .total-box {
            background-color: #f0f0f0;
            color: #000;
            padding: 0.5mm;
            border-radius: 0.125rem;
            font-weight: 700;
            font-size: 10pt;
            margin-top: 0.5mm;
        }
        #label-total { font-size: 10pt; }

        .cod-tag {
            font-size: 6.5pt;
            font-weight: 700;
            color: #000;
            background-color: #FFFFFF;
            padding: 0.5mm 1mm;
            margin-top: 1mm;
            line-height: 1.1;
            border: 1px solid #000;
            border-radius: 4px;
            display: block;
            text-align: right;
        }

        .label-footer {
            border-top: 1px dashed #000;
            text-align: center;
            font-size: 7pt;
            font-weight: 700;
            padding-top: 1mm;
            width: 100%;
        }

        /* --- Styles សម្រាប់ QR Label ថ្មី --- */
        #qr-label-container {
            /* Center content */
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #qrcode img {
            margin: 0 auto; /* Center QR image */
            display: block;
        }

        /* ---------------- PRINT STYLES ---------------- */
        @page {
            size: var(--page-width) var(--page-height);
            margin-top: var(--page-margin-top);
            margin-right: var(--page-margin-right);
            margin-bottom: var(--page-margin-bottom);
            margin-left: var(--page-margin-left);
        }

        @media print {
            html, body {
                width: var(--page-width);
                height: var(--page-height);
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
            }

            /* Apply print styles to generic label-page class */
            .label-page {
                width: 100%;
                height: 100%;
                margin: 0 !important;
                padding: 1mm 3mm !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                page-break-after: always; /* ដាក់ Page break */
                margin-bottom: 0 !important;
            }

            /* Class សម្រាប់លាក់ Element ពេល Print (ប្រើសម្រាប់លាក់ Label មួយពេលព្រីនមួយទៀត) */
            .hidden-on-print {
                display: none !important;
            }

            .no-print { display: none !important; }
            #styleEditor { display: none !important; }
        }
        /* ---------------- END PRINT STYLES ---------------- */


        body { background-color: #f0f4f8; padding: 1rem; }

        /* Modal Styling */
        #print-guide-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        #print-guide-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Design Mode Styles */
        .editable-element {
            cursor: default;
            transition: outline 0.1s ease-in-out;
        }
        .design-mode-active .editable-element {
            cursor: text;
        }
        .editable-element.selected {
            outline: 2px dashed #007bff;
            z-index: 10;
        }
        
        #styleEditor {
            position: fixed;
            z-index: 1001;
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
            bottom: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            max-width: 90%;
            transition: bottom 0.3s ease-in-out;
        }

    </style>
</head>
<body>

    <!-- UI មុនព្រីន (Control Panel) -->
    <div class="no-print max-w-sm mx-auto p-4 bg-white rounded-lg shadow-lg mb-6 text-center">
        <h1 class="text-xl font-bold text-gray-800 mb-2">ទម្រង់ព្រីន Label</h1>
        <p class="text-sm text-gray-600 mb-4">ទំហំគោល (78mm x 50mm)</p>

        <!-- ជម្រើសទំហំ Label -->
        <div class="border-t border-b border-gray-200 py-4 my-4">
            <h2 class="text-md font-bold text-gray-700 mb-3 text-left">ជម្រើសទំហំ Label (mm)</h2>
            <div class="flex items-center gap-6 mb-3">
                <label class="flex items-center">
                    <input type="radio" name="label_size" value="standard" checked class="form-radio">
                    <span class="ml-2 text-sm">Standard (78x50)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="label_size" value="custom" class="form-radio">
                    <span class="ml-2 text-sm">Customize</span>
                </label>
            </div>
            <div id="custom-size-inputs" class="hidden grid grid-cols-2 gap-3">
                <div>
                    <label for="customWidth" class="block text-xs font-medium text-gray-600 text-left mb-1">ទទឹង (Width)</label>
                    <input type="number" id="customWidth" value="78" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="customHeight" class="block text-xs font-medium text-gray-600 text-left mb-1">បណ្ដោយ (Height)</label>
                    <input type="number" id="customHeight" value="50" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
            </div>
        </div>

        <!-- កំណត់ Margins -->
        <div class="border-b border-gray-200 pb-4 mb-4">
            <h2 class="text-md font-bold text-gray-700 mb-3 text-left">កំណត់ Margins បោះពុម្ព (mm)</h2>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="marginTop" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin លើ (Top)</label>
                    <input type="number" id="marginTop" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="marginRight" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin ស្ដាំ (Right)</label>
                    <input type="number" id="marginRight" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="marginBottom" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin ក្រោម (Bottom)</label>
                    <input type="number" id="marginBottom" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="marginLeft" class="block text-xs font-medium text-gray-600 text-left mb-1">Margin ឆ្វេង (Left)</label>
                    <input type="number" id="marginLeft" value="0" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                </div>
            </div>
        </div>

        <!-- Design Mode Toggle -->
        <div class="border-b border-gray-200 pb-4 mb-4">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="designModeToggle" class="form-checkbox h-5 w-5 text-blue-600">
                <span class="ml-2 text-sm text-gray-700">កែរចនាបទ Label</span>
            </label>
        </div>

        <!-- Reset Button -->
        <div class="border-b border-gray-200 pb-4 mb-4">
            <button id="resetDesignButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                Reset រចនាបទ ទៅដូចដើម
            </button>
        </div>

        <div class="flex flex-col gap-2">
            <button id="guideButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                ព័ត៌មានបោះពុម្ព(ការកំណត់)
            </button>

            <!-- Main Print Button -->
            <button id="printButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300">
                Print Label
            </button>

            <!-- QR Print Button (Hidden by default, shown if map exists) -->
            <button id="printQRButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300">
                Print QR Code Map
            </button>
        </div>
    </div>

    <!-- Modal (Print Guide) -->
    <div id="print-guide-modal" class="no-print flex">
        <div id="print-guide-content">
            <h2 class="text-lg font-bold mb-2 text-gray-800">ការកំណត់ Printer ត្រឹមត្រូវ</h2>
            <ul class="list-disc pl-5 text-sm text-gray-700 mb-4 text-left">
                <li>ជ្រើស <strong>Destination:</strong> EML-200L (2 inch)</li>
                <li><strong>Paper size:</strong> Custom (ប្រើទំហំដែលបានកំណត់)</li>
                <li><strong>Margins:</strong> None (ឬ ប្រើ Custom Margins)</li>
                <li><strong>Background graphics:</strong> ON</li>
            </ul>
            <button id="closeGuide" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full">បិទ</button>
        </div>
    </div>

    <!-- Style Editor Panel -->
    <div id="styleEditor" class="no-print">
        <div class="flex justify-between items-center mb-2">
            <h4 id="editorTitle" class="text-sm font-bold">Edit Element</h4>
            <button id="closeEditor" class="text-xl font-bold text-red-500 leading-none">&times;</button>
        </div>
        <div class="mb-2">
            <label class="block text-xs mb-1">Font Size (pt)</label>
            <input type="number" id="editorFontSize" class="w-full border border-gray-300 p-1 rounded" step="0.5">
        </div>
    </div>


    <!-- ========================================= -->
    <!--          LABEL 1: Main Information        -->
    <!-- ========================================= -->
    <div id="label-container" class="label-page">
        <div class="label-header editable-element" id="label-header-el">
            <span><span id="label-page">N/A</span></span>
            <span>User: <span id="label-user">N/A</span></span>
            <span>ID: <span id="label-order-id">ORD-XXXXX</span></span>
        </div>

        <div class="info-row" id="info-row-el">
            <div class="info-block left">
                <div class="small-text editable-element" id="label-recipient-title">អ្នកទទួល / Recipient:</div>
                <div id="label-name" class="big-text editable-element">ឈ្មោះអតិថិជន</div>
                <div id="label-phone" class="mt-0.5 editable-element">0xx xxx xxx</div>

                <div class="small-text mt-1 editable-element" id="label-location-title">ទីតាំង / Location:</div>
                <div id="label-location" class="data-text editable-element">ភ្នំពេញថ្មី</div>

                <div class="small-text mt-1 editable-element" id="label-address-title">អាសយដ្ឋាន / Address:</div>
                <div id="label-address" class="data-text editable-element">(មិនបានបញ្ជាក់)</div>
            </div>

            <div class="info-block right">
                <div class="small-text editable-element" id="label-date-title">កាលបរិច្ឆេទ:</div>
                <div id="label-date" class="data-text editable-element">DD/MM/YYYY</div>

                <div class="total-box editable-element" id="label-total-box">តម្លៃសរុប: <span id="label-total">$0.00</span></div>

                <div class="small-text mt-1 editable-element" id="label-payment-title">ស្ថានភាពបង់ប្រាក់:</div>
                <div id="label-payment" class="data-text font-bold editable-element">Unpaid</div>

                <div class="small-text mt-1 editable-element" id="label-shipping-title">ដឹកជញ្ជូនដោយ:</div>
                <div id="label-shipping" class="data-text editable-element">N/A</div>
                
                <div id="label-cod" class="cod-tag editable-element hidden">COD (Cash on Delivery)</div>
            </div>
        </div>

        <div class="label-footer editable-element" id="label-footer-el">សូមដឹកជញ្ជូនដោយប្រុងប្រយ័ត្ន!</div>
    </div>

    <!-- ========================================= -->
    <!--          LABEL 2: QR Code (Hidden)        -->
    <!-- ========================================= -->
    <div id="qr-label-container" class="label-page hidden">
        <div class="w-full h-full flex flex-col justify-center items-center text-center">
            <h2 class="text-sm font-bold mb-2">Scan for Location</h2>
            <!-- QR Code Render Target -->
            <div id="qrcode" class="mb-2 bg-white p-1"></div>
            <p class="text-xs font-bold" id="qr-map-link-text">Google Maps Link</p>
        </div>
    </div>

    <!-- Audio Players -->
    <audio id="audioWelcome" src="welcome.mp3" preload="auto"></audio>
    <audio id="audioGuide" src="guide.mp3" preload="auto"></audio>
    <audio id="audioSuccess" src="success.mp3" preload="auto"></audio>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());
    
    // Audio elements
    const audioWelcome = document.getElementById('audioWelcome');
    const audioGuide = document.getElementById('audioGuide');
    const audioSuccess = document.getElementById('audioSuccess');

    // *** Audio Management Logic ***
    let currentAudio = null;      
    let interruptedAudio = null;  

    function onAudioEnded() {
        if (interruptedAudio) {
            currentAudio = interruptedAudio;
            interruptedAudio = null;
            const promise = currentAudio.play(); 
            if (promise !== undefined) {
                promise.catch(error => {}).then(() => {});
            }
            currentAudio.removeEventListener('ended', onAudioEnded);
            currentAudio.addEventListener('ended', onAudioEnded, { once: true });
        } else {
            currentAudio = null;
        }
    }

    function playAudio(audioElement) {
        if (!audioElement) return;
        if (currentAudio && currentAudio !== audioElement && !currentAudio.paused) {
            currentAudio.pause();
            interruptedAudio = currentAudio; 
        } else if (!currentAudio || currentAudio !== audioElement) {
            interruptedAudio = null; 
        }
        currentAudio = audioElement;
        if (currentAudio.currentTime > 0 && currentAudio === interruptedAudio) {
        } else {
            currentAudio.currentTime = 0; 
        }
        const promise = currentAudio.play();
        if (promise !== undefined) {
            promise.catch(error => {}).then(() => {});
        }
        currentAudio.removeEventListener('ended', onAudioEnded); 
        currentAudio.addEventListener('ended', onAudioEnded, { once: true }); 
    }

    if (params.id) {
        // Fill Data
        document.getElementById('label-page').textContent = params.page || 'N/A';
        document.getElementById('label-user').textContent = params.user || 'N/A';
        document.getElementById('label-order-id').textContent = params.id || 'N/A';
        document.getElementById('label-name').textContent = params.name || 'N/A';
        document.getElementById('label-phone').textContent = params.phone || 'N/A';
        document.getElementById('label-location').textContent = params.location || 'N/A';
        document.getElementById('label-address').textContent = params.address || '(មិនបានបញ្ជាក់)';
        document.getElementById('label-total').textContent = params.total ? `$${parseFloat(params.total).toFixed(2)}` : 'N/A';
        document.getElementById('label-payment').textContent = params.payment || 'Unpaid';
        document.getElementById('label-shipping').textContent = params.shipping || 'N/S';

        // COD Logic
        const paymentStatus = params.payment ? params.payment.toLowerCase() : 'unpaid';
        const codElement = document.getElementById('label-cod');
        if (codElement) {
            if (paymentStatus === 'unpaid') {
                codElement.classList.remove('hidden');
                codElement.textContent = 'COD (Cash on Delivery)';
            } else {
                codElement.classList.add('hidden');
            }
        }

        // ===============================================
        // NEW: QR Code Logic (Check for 'map' param)
        // ===============================================
        if (params.map) {
            const qrContainer = document.getElementById('qr-label-container');
            const qrButton = document.getElementById('printQRButton');
            const mapUrl = decodeURIComponent(params.map);

            // 1. Show the QR Label Container (Preview)
            qrContainer.classList.remove('hidden');
            
            // 2. Show the Print QR Button
            qrButton.classList.remove('hidden');

            // 3. Generate the QR Code
            document.getElementById('qrcode').innerHTML = ""; // Clear old code
            new QRCode(document.getElementById('qrcode'), {
                text: mapUrl,
                width: 128, // QR Size
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }
        // ===============================================

        const today = new Date();
        const d = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        document.getElementById('label-date').textContent = d;

        const playWelcomeOnFirstInteraction = () => {
            playAudio(audioWelcome);
        };
        document.body.addEventListener('click', playWelcomeOnFirstInteraction, { once: true });
        document.body.addEventListener('touchstart', playWelcomeOnFirstInteraction, { once: true });
    }

    // ===============================================
    // PRINT LOGIC (Handle Single Label Printing)
    // ===============================================
    function printSpecificLabel(containerIdToPrint) {
        // Find all label pages
        const allLabels = document.querySelectorAll('.label-page');
        
        // Loop through and hide the ones NOT being printed
        allLabels.forEach(label => {
            if (label.id !== containerIdToPrint) {
                label.classList.add('hidden-on-print');
            } else {
                label.classList.remove('hidden-on-print');
            }
        });

        // Trigger Print
        window.print();

        // Remove hidden classes after print dialogue closes (so preview returns to normal)
        // Note: window.print() is blocking in many browsers, but not all. 
        // We use a small timeout or just run immediately after since JS pauses.
        allLabels.forEach(label => {
            label.classList.remove('hidden-on-print');
        });

        setTimeout(() => {
            playAudio(audioSuccess);
        }, 1000); 
    }

    // Button: Print MAIN Label
    document.getElementById('printButton').addEventListener('click', () => {
        printSpecificLabel('label-container');
    });

    // Button: Print QR Code
    document.getElementById('printQRButton').addEventListener('click', () => {
        printSpecificLabel('qr-label-container');
    });
    // ===============================================


    // Guide modal logic
    const guideBtn = document.getElementById('guideButton');
    const guideModal = document.getElementById('print-guide-modal');
    const closeGuide = document.getElementById('closeGuide');

    guideBtn.addEventListener('click', () => {
        playAudio(audioGuide);
        guideModal.style.display = 'flex';
    });
    
    closeGuide.addEventListener('click', () => {
        if (currentAudio && currentAudio === audioGuide) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            onAudioEnded(); 
        }
        guideModal.style.display = 'none';
    });

    // Label Size Logic (Updates ALL .label-page elements)
    const rootStyle = document.documentElement.style;
    const sizeRadios = document.querySelectorAll('input[name="label_size"]');
    const customInputsDiv = document.getElementById('custom-size-inputs');
    const customWidthInput = document.getElementById('customWidth');
    const customHeightInput = document.getElementById('customHeight');
    const labelContainers = document.querySelectorAll('.label-page'); // Select ALL labels
    const standardRatio = 78 / 50; 
    let isUpdating = false; 

    function updateLabelSize(width, height) {
        if (isUpdating) return;
        rootStyle.setProperty('--page-width', `${width}mm`);
        rootStyle.setProperty('--page-height', `${height}mm`);
        
        // Update pixel dimensions for screen preview
        const pixelWidth = width * 3.7795275591;
        const pixelHeight = height * 3.7795275591;
        
        labelContainers.forEach(container => {
            container.style.width = `${pixelWidth}px`;
            container.style.height = `${pixelHeight}px`;
        });
    }

    sizeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'standard') {
                customInputsDiv.classList.add('hidden');
                customWidthInput.value = 78;
                customHeightInput.value = 50;
                updateLabelSize(78, 50);
            } else {
                customInputsDiv.classList.remove('hidden');
            }
        });
    });
    customWidthInput.addEventListener('input', (e) => {
        isUpdating = true;
        const width = parseFloat(e.target.value) || 0;
        const height = width / standardRatio;
        customHeightInput.value = height.toFixed(2);
        updateLabelSize(width, height);
        isUpdating = false;
    });
    customHeightInput.addEventListener('input', (e) => {
        isUpdating = true;
        const height = parseFloat(e.target.value) || 0;
        const width = height * standardRatio;
        customWidthInput.value = width.toFixed(2);
        updateLabelSize(width, height);
        isUpdating = false;
    });

    // Margin Logic
    const marginInputs = [
        { id: 'marginTop', key: '--page-margin-top' },
        { id: 'marginRight', key: '--page-margin-right' },
        { id: 'marginBottom', key: '--page-margin-bottom' },
        { id: 'marginLeft', key: '--page-margin-left' }
    ];
    marginInputs.forEach(margin => {
        const savedValue = localStorage.getItem(margin.key);
        if (savedValue !== null) {
            const valueInMm = `${savedValue || 0}mm`;
            rootStyle.setProperty(margin.key, valueInMm);
            document.getElementById(margin.id).value = savedValue || 0;
        }
    });
    marginInputs.forEach(margin => {
        document.getElementById(margin.id).addEventListener('input', (e) => {
            const value = e.target.value || 0;
            const valueInMm = `${value}mm`;
            rootStyle.setProperty(margin.key, valueInMm);
            localStorage.setItem(margin.key, value);
        });
    });

    // Design Mode Logic
    const designModeToggle = document.getElementById('designModeToggle');
    const styleEditor = document.getElementById('styleEditor');
    const editorTitle = document.getElementById('editorTitle');
    const editorFontSize = document.getElementById('editorFontSize');
    const closeEditorBtn = document.getElementById('closeEditor');
    const editableElements = document.querySelectorAll('.editable-element');
    const STYLES_KEY = 'labelStyles';

    const resetDesignButton = document.getElementById('resetDesignButton');
    resetDesignButton.addEventListener('click', () => {
        localStorage.removeItem(STYLES_KEY);
        window.location.reload();
    });

    let isDesignMode = false;
    let selectedElement = null;

    function loadAllStyles() {
        const savedStyles = JSON.parse(localStorage.getItem(STYLES_KEY) || '{}');
        editableElements.forEach(el => {
            const style = savedStyles['#' + el.id];
            if (style) {
                el.style.fontSize = style.fontSize;
            }
        });
    }

    function saveStyle(element) {
        if (!element) return;
        const savedStyles = JSON.parse(localStorage.getItem(STYLES_KEY) || '{}');
        const styleData = { fontSize: element.style.fontSize };
        let existingStyle = savedStyles['#' + element.id] || {};
        existingStyle.fontSize = styleData.fontSize; 
        savedStyles['#' + element.id] = existingStyle;
        localStorage.setItem(STYLES_KEY, JSON.stringify(savedStyles));
    }

    function showEditor(element) {
        selectedElement = element;
        editableElements.forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        styleEditor.style.bottom = '10px'; 
        editorTitle.textContent = `Edit: #${element.id}`;
        let currentSize = element.style.fontSize;
        if (!currentSize) {
            currentSize = window.getComputedStyle(element).fontSize;
        }
        editorFontSize.value = parseFloat(currentSize);
    }

    function hideEditor() {
        styleEditor.style.bottom = '-200px'; 
        if (selectedElement) {
            selectedElement.classList.remove('selected');
        }
        selectedElement = null;
    }

    editableElements.forEach(el => {
        el.addEventListener('click', (ev) => {
            if (!isDesignMode) return;
            showEditor(el);
        });
    });

    designModeToggle.addEventListener('change', (e) => {
        isDesignMode = e.target.checked;
        labelContainers.forEach(container => {
             if (isDesignMode) {
                container.classList.add('design-mode-active');
            } else {
                container.classList.remove('design-mode-active');
            }
        });
        if (!isDesignMode) hideEditor();
    });

    closeEditorBtn.addEventListener('click', hideEditor);
    editorFontSize.addEventListener('input', (e) => {
        if (selectedElement) {
            const newSize = parseFloat(e.target.value) || 10;
            selectedElement.style.fontSize = `${newSize}pt`;
            saveStyle(selectedElement);
        }
    });

    loadAllStyles();

});
</script>

</body>
</html>
